<!DOCTYPE html>
<html>
	<head><title>A Javascript Stompbox</title></head>
	<style>
		body {
			background: #313131;
			color: white;
			font-family: Helvetica, Arial, sans-serif;
			padding: 100px;
		}

		h1 {
			color: #70bce5;
			font-size: 40px;
			margin: 0 0 50px;
			text-shadow: 3px 3px 2px rgba(0,0,0,0.51)
		}

		label {
			font-size: 24px;
			margin-right: 30px;
		}

	</style>
	<body>
		<h1>Guitar Effects with the Javascript Audio API</h1>
		<div>
			<label>Tone: <input id="tone" type="range" step="0.01" min="0" max="1" value="0"></label><br>
			<label>Distortion: <input id="dist" type="range" step="1" min="0" max="100" value="0"></label><br>
			<label>Gain: <input id="gain" type="range" step="0.01" min="0" max="1" value="0"></label>
		</div>
		<script>
			window.onload = function () {
				navigator.webkitGetUserMedia({audio:true}, initAudio, error);
			};

			function error() {
				alert('Stream generation failed.');
			}

			function initAudio(stream) {
				var context = new AudioContext(),
				source = context.createMediaStreamSource(stream),
				tone = context.createBiquadFilter(),
				distortion = context.createWaveShaper(),
				gain = context.createGain();

				//Set biquad filter type (0 == lowpass)
				tone.type = 'lowpass';

				//Set initial node values
				tone.frequency.value = calcFilterFrequency(0, context);
				distortion.curve = makeDistortionCurve(0, context);
				gain.gain.value = 1;

				//Connect nodes to source and destination
				source.connect(tone);
				tone.connect(distortion);
				distortion.connect(gain);
				gain.connect(context.destination);

				//Bind slider events
				document.getElementById("gain").oninput = function () {
					gain.gain.value = this.value;
				};

				document.getElementById("tone").oninput = function () {
					tone.frequency.value = calcFilterFrequency(this.value, context);
				};

				document.getElementById("dist").oninput = function () {
					distortion.curve = makeDistortionCurve(this.value, context);
				};
			}

			function calcFilterFrequency(value, context) {
				var minValue = 600, //Minimum frequency cutoff
					maxValue = context.sampleRate / 2, //frequencies > 20kHz are inaudible
					numberOfOctaves = Math.log(maxValue / minValue) / Math.LN2,
					multiplier = Math.pow(2, numberOfOctaves * (value - 1.0)); //More octaves at the bottom of the curve

				//Return frequency value between min and max.
				return maxValue * multiplier;
			}

			function makeDistortionCurve(value, context) {
				var k = value,
				n_samples = context.sampleRate,
				curve = new Float32Array(n_samples),
				deg = Math.PI / 180,
				i = 0,
				x;

				for (i; i < n_samples; ++i ) {
					x = i * 2 / n_samples - 1;
					curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
				}

				return curve;
			}
		</script>
	</body>
</html>

